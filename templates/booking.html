<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking</title>
    <style>
        /* Подключаем шрифт Comic Sans MS */
        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #e6e6fa, #d8b9d6); /* Лавандовый градиент */
            color: #4b0082; /* Темный фиолетовый для текста */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }

        h1 {
            font-size: 3rem;
            color: #6a5acd; /* Лаванда */
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        }

        form {
            max-width: 500px;
            width: 100%;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-row label {
            display: block;
            margin-bottom: 5px;
        }

        .form-row input, .form-row select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border-radius: 10px;
            border: 1px solid #d8b9d6; /* Лавандовый бордер */
            font-size: 1.1rem;
        }

        .form-row select {
            background-color: #f5f5f5;
        }

        .form-row button {
            padding: 12px 25px;
            width: 100%;
            background-color: #8a2be2; /* Фиолетовый */
            color: white;
            border: none;
            border-radius: 50px; /* Овальная форма кнопки */
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .form-row button:hover {
            background-color: #9370db; /* Лаванда с фиолетовым оттенком */
            transform: scale(1.05);
        }

        #submit-button:disabled {
            background-color: #cccccc;
        }

        .form-row a {
            text-decoration: none;
            display: block;
            text-align: center;
            margin-top: 20px;
        }

        .form-row a button {
            background-color: #ba55d3; /* Средний фиолетовый */
            color: white;
            border-radius: 50px;
            padding: 12px 25px;
            font-size: 1.2rem;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .form-row a button:hover {
            background-color: #6a5acd; /* Лаванда */
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <h1>Запись в салон "Красота в деталях"</h1>
    <form action="/bookingdone/{{.ServiceID}}" method="POST">
        <!-- Скрытое поле для передачи service_id -->
        <input type="hidden" name="service_id" value="{{.ServiceID}}">
    
        <!-- Строка для выбора мастера, даты и времени -->
        <div class="form-row">
            <label for="master">Выберите мастера:</label>
            <select name="master_id" id="master">
                <option value="" disabled selected>Выберите мастера</option>
                {{range .Masters}}
                    <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
            </select>
        </div>
    
        <div class="form-row">
            <label for="date">Выберите доступную дату:</label>
            <select name="date" id="date" disabled>
                <option value="" disabled selected>Выберите дату</option>
            </select>
        </div>
    
        <div class="form-row">
            <label for="time">Выберите доступное время:</label>
            <select name="time" id="time" disabled>
                <option value="" disabled selected>Выберите время</option>
            </select>
        </div>
    
        <!-- Строка для ввода имени и номера телефона -->
        <div class="form-row">
            <label for="name">Имя:</label>
            <input type="text" id="name" name="name" required placeholder="Введите ваше имя">
        </div>
    
        <div class="form-row">
            <label for="phone">Номер телефона:</label>
            <input type="tel" id="phone" name="phone" required placeholder="Введите ваш номер телефона">
        </div>
    
        <!-- Кнопка записи -->
        <div class="form-row">
            <button type="submit" disabled id="submit-button">Записаться</button>
        </div>

        <!-- Back to Home button -->
        <div class="form-row">
            <a href="/"><button type="button">Вернуться на главную страницу</button></a>
        </div>
    </form>
    

    <script>
        const masterSelect = document.getElementById('master');
        const dateSelect = document.getElementById('date');
        const timeSelect = document.getElementById('time');
        const submitButton = document.getElementById('submit-button');
        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');
    
        // Функция для преобразования даты в формат DD.MM.YY
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear()).slice(-2); // Берем последние 2 цифры года
            return `${day}.${month}.${year}`;
        }
    
        // Функция для преобразования времени в формат HH:MM
        function formatTime(timeString) {
            // Создаем объект Date из строки
            const date = new Date(timeString);
            // Получаем часы и минуты в UTC
            const hours = String(date.getUTCHours()).padStart(2, '0'); // добавляем ведущий ноль
            const minutes = String(date.getUTCMinutes()).padStart(2, '0'); // добавляем ведущий ноль
            return `${hours}:${minutes}`;
        }


    
        // Событие выбора мастера
        masterSelect.addEventListener('change', function () {
            const masterID = this.value;
    
            if (masterID) {
                fetch(`/api/masters/${masterID}/dates`) // Эндпоинт для получения доступных дат
                    .then(response => response.json())
                    .then(data => {
                        dateSelect.innerHTML = '<option value="" disabled selected>Выберите дату</option>';
                        timeSelect.innerHTML = '<option value="" disabled selected>Выберите время</option>';
                        submitButton.disabled = true;
    
                        // Используем Set для фильтрации уникальных дат
                        const uniqueDates = new Set();
    
                        data.dates.forEach(date => {
                            uniqueDates.add(date); // Добавляем дату в Set, который автоматически удаляет дубликаты
                        });
    
                        // Преобразуем уникальные даты и добавляем в выпадающий список
                        uniqueDates.forEach(date => {
                            const formattedDate = formatDate(date); // Преобразуем дату в нужный формат
                            const option = document.createElement('option');
                            option.value = date; // Используем оригинальную дату для отправки
                            option.textContent = formattedDate; // Отображаем преобразованную дату
                            dateSelect.appendChild(option);
                        });
    
                        dateSelect.disabled = false;
                        timeSelect.disabled = true;
                    });
            } else {
                dateSelect.disabled = true;
                timeSelect.disabled = true;
                submitButton.disabled = true;
            }
        });
    
        // Событие выбора даты
        dateSelect.addEventListener('change', function () {
            const masterID = masterSelect.value;
            const selectedDate = this.value;
    
            if (masterID && selectedDate) {
                fetch(`/api/masters/${masterID}/dates/${selectedDate}/times`) // Эндпоинт для получения времени
                    .then(response => response.json())
                    .then(data => {
                        timeSelect.innerHTML = '<option value="" disabled selected>Выберите время</option>';
    
                        data.times.forEach(time => {
                            const formattedTime = formatTime(time); // Преобразуем время в формат HH:MM
                            const option = document.createElement('option');
                            option.value = time;
                            option.textContent = formattedTime; // Отображаем преобразованное время
                            timeSelect.appendChild(option);
                        });
    
                        timeSelect.disabled = false;
                        submitButton.disabled = true;
                    });
            } else {
                timeSelect.disabled = true;
                submitButton.disabled = true;
            }
        });
    
        // Событие выбора времени
        timeSelect.addEventListener('change', function () {
            if (this.value && nameInput.value && phoneInput.value) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        });
    
        // Проверка всех полей
        function checkForm() {
            if (nameInput.value && phoneInput.value && masterSelect.value && dateSelect.value && timeSelect.value) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }
    
        // Событие на изменение в полях имени и телефона
        nameInput.addEventListener('input', checkForm);
        phoneInput.addEventListener('input', checkForm);
    </script>
    
</body>
</html>