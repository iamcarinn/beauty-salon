<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking</title>
</head>
<body>
    <h1>Available Slots for Booking</h1>

    <form action="/booking" method="POST">
        <!-- Выпадающий список мастеров -->
        <label for="master">Select Master:</label>
        <select name="master_id" id="master">
            <option value="" disabled selected>Select a Master</option>
            {{range .Masters}}
                <option value="{{.ID}}">{{.Name}}</option>
            {{end}}
        </select>

        <!-- Выпадающий список дат -->
        <label for="date">Select Date:</label>
        <select name="date" id="date" disabled>
            <option value="" disabled selected>Select a Date</option>
        </select>

        <!-- Выпадающий список времени -->
        <label for="time">Select Time:</label>
        <select name="time" id="time" disabled>
            <option value="" disabled selected>Select a Time</option>
        </select>

        <button type="submit" disabled id="submit-button">Book Slot</button>
    </form>

    <script>
        const masterSelect = document.getElementById('master');
        const dateSelect = document.getElementById('date');
        const timeSelect = document.getElementById('time');
        const submitButton = document.getElementById('submit-button');

        // Функция для преобразования даты в формат DD-MM-YYYY
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Событие выбора мастера
        masterSelect.addEventListener('change', function () {
            const masterID = this.value;

            if (masterID) {
                fetch(`/api/masters/${masterID}/dates`) // Эндпоинт для получения доступных дат
                    .then(response => response.json())
                    .then(data => {
                        dateSelect.innerHTML = '<option value="" disabled selected>Select a Date</option>';
                        timeSelect.innerHTML = '<option value="" disabled selected>Select a Time</option>';
                        submitButton.disabled = true;

                        // Используем Set для фильтрации уникальных дат
                        const uniqueDates = new Set();

                        data.dates.forEach(date => {
                            uniqueDates.add(date); // Добавляем дату в Set, который автоматически удаляет дубликаты
                        });

                        // Преобразуем уникальные даты и добавляем в выпадающий список
                        uniqueDates.forEach(date => {
                            const formattedDate = formatDate(date); // Преобразуем дату в нужный формат
                            const option = document.createElement('option');
                            option.value = date; // Используем оригинальную дату для отправки
                            option.textContent = formattedDate; // Отображаем преобразованную дату
                            dateSelect.appendChild(option);
                        });

                        dateSelect.disabled = false;
                        timeSelect.disabled = true;
                    });
            } else {
                dateSelect.disabled = true;
                timeSelect.disabled = true;
                submitButton.disabled = true;
            }
        });

        // Событие выбора даты
        dateSelect.addEventListener('change', function () {
            const masterID = masterSelect.value;
            const selectedDate = this.value;

            if (masterID && selectedDate) {
                fetch(`/api/masters/${masterID}/dates/${selectedDate}/times`) // Эндпоинт для получения времени
                    .then(response => response.json())
                    .then(data => {
                        timeSelect.innerHTML = '<option value="" disabled selected>Select a Time</option>';

                        data.times.forEach(time => {
                            const option = document.createElement('option');
                            option.value = time;
                            option.textContent = time;
                            timeSelect.appendChild(option);
                        });

                        timeSelect.disabled = false;
                        submitButton.disabled = true;
                    });
            } else {
                timeSelect.disabled = true;
                submitButton.disabled = true;
            }
        });

        // Событие выбора времени
        timeSelect.addEventListener('change', function () {
            if (this.value) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        });
    </script>
</body>
</html>
