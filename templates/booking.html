<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking</title>
    <style>
        form {
            max-width: 500px;
            margin: 0 auto;
        }
        .form-row {
            margin-bottom: 15px;
        }
        .form-row label {
            display: block;
            margin-bottom: 5px;
        }
        .form-row input, .form-row select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
        }
        #submit-button {
            padding: 10px 20px;
            width: 100%;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        #submit-button:disabled {
            background-color: #cccccc;
        }
    </style>
</head>
<body>
    <h1>Available Slots for Booking</h1>

    <form action="/booking" method="POST">
        <!-- Строка для выбора мастера, даты и времени -->
        <div class="form-row">
            <label for="master">Select Master:</label>
            <select name="master_id" id="master">
                <option value="" disabled selected>Select a Master</option>
                {{range .Masters}}
                    <option value="{{.ID}}">{{.Name}}</option>
                {{end}}
            </select>
        </div>

        <div class="form-row">
            <label for="date">Select Date:</label>
            <select name="date" id="date" disabled>
                <option value="" disabled selected>Select a Date</option>
            </select>
        </div>

        <div class="form-row">
            <label for="time">Select Time:</label>
            <select name="time" id="time" disabled>
                <option value="" disabled selected>Select a Time</option>
            </select>
        </div>

        <!-- Строка для ввода имени и номера телефона -->
        <div class="form-row">
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required placeholder="Enter your name">
        </div>

        <div class="form-row">
            <label for="phone">Phone Number:</label>
            <input type="tel" id="phone" name="phone" required placeholder="Enter your phone number">
        </div>

        <!-- Кнопка записи -->
        <div class="form-row">
            <button type="submit" disabled id="submit-button">Book Slot</button>
        </div>
    </form>

    <script>
        const masterSelect = document.getElementById('master');
        const dateSelect = document.getElementById('date');
        const timeSelect = document.getElementById('time');
        const submitButton = document.getElementById('submit-button');
        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');

        // Функция для преобразования даты в формат DD-MM-YYYY
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Функция для преобразования времени в формат HH:MM
        function formatTime(timeString) {
            const time = new Date(timeString);
            const hours = String(time.getHours()).padStart(2, '0');
            const minutes = String(time.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Событие выбора мастера
        masterSelect.addEventListener('change', function () {
            const masterID = this.value;

            if (masterID) {
                fetch(`/api/masters/${masterID}/dates`) // Эндпоинт для получения доступных дат
                    .then(response => response.json())
                    .then(data => {
                        dateSelect.innerHTML = '<option value="" disabled selected>Select a Date</option>';
                        timeSelect.innerHTML = '<option value="" disabled selected>Select a Time</option>';
                        submitButton.disabled = true;

                        // Используем Set для фильтрации уникальных дат
                        const uniqueDates = new Set();

                        data.dates.forEach(date => {
                            uniqueDates.add(date); // Добавляем дату в Set, который автоматически удаляет дубликаты
                        });

                        // Преобразуем уникальные даты и добавляем в выпадающий список
                        uniqueDates.forEach(date => {
                            const formattedDate = formatDate(date); // Преобразуем дату в нужный формат
                            const option = document.createElement('option');
                            option.value = date; // Используем оригинальную дату для отправки
                            option.textContent = formattedDate; // Отображаем преобразованную дату
                            dateSelect.appendChild(option);
                        });

                        dateSelect.disabled = false;
                        timeSelect.disabled = true;
                    });
            } else {
                dateSelect.disabled = true;
                timeSelect.disabled = true;
                submitButton.disabled = true;
            }
        });

        // Событие выбора даты
        dateSelect.addEventListener('change', function () {
            const masterID = masterSelect.value;
            const selectedDate = this.value;

            if (masterID && selectedDate) {
                fetch(`/api/masters/${masterID}/dates/${selectedDate}/times`) // Эндпоинт для получения времени
                    .then(response => response.json())
                    .then(data => {
                        timeSelect.innerHTML = '<option value="" disabled selected>Select a Time</option>';

                        data.times.forEach(time => {
                            const formattedTime = formatTime(time); // Преобразуем время в формат HH:MM
                            const option = document.createElement('option');
                            option.value = time;
                            option.textContent = formattedTime; // Отображаем преобразованное время
                            timeSelect.appendChild(option);
                        });

                        timeSelect.disabled = false;
                        submitButton.disabled = true;
                    });
            } else {
                timeSelect.disabled = true;
                submitButton.disabled = true;
            }
        });

        // Событие выбора времени
        timeSelect.addEventListener('change', function () {
            if (this.value && nameInput.value && phoneInput.value) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        });

        // Проверка всех полей
        function checkForm() {
            if (nameInput.value && phoneInput.value && masterSelect.value && dateSelect.value && timeSelect.value) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        // Событие на изменение в полях имени и телефона
        nameInput.addEventListener('input', checkForm);
        phoneInput.addEventListener('input', checkForm);
    </script>
</body>
</html>
